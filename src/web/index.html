<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件管理系统</title>

</head>
<body>
<div class="container">
    <h1>文件传输助手</h1>
    <p>选择文件并点击上传，轻松完成文件传输。</p>
    <div class="file-box">
        <input type="file" id="fileInput" class="file-input">
        <label for="fileInput" class="custom-upload-btn">选择文件</label>
        <button onclick="uploadFile()" class="custom-upload-btn">上传文件</button>
    </div>
    <div class="status-box">
        <p id="statusText">等待文件选择...</p>
        <ul id="fileList"></ul>
    </div>
</div>
<style>
    /* 重置默认样式 */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    /* 页面背景与字体 */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #6a11cb, #2575fc);
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        padding: 20px;
    }

    /* 容器样式 */
    .container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 30px;
        max-width: 500px;
        width: 100%;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    /* 标题样式 */
    h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
    }

    /* 描述文字样式 */
    p {
        font-size: 1rem;
        margin-bottom: 20px;
        color: #e0e0e0;
    }

    /* 文件选择框样式 */
    .file-box {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 20px;
    }

    .file-input {
        display: none;
    }

    .file-table {
        width: 100%;
        border-collapse: collapse;
        font-family: 'Segoe UI', system-ui;
    }

    .file-item {
        display: grid;
        grid-template-columns: minmax(200px, 1fr) 120px 100px;
        align-items: center;
        padding: 12px 20px;
        border-bottom: 1px solid #e0e0e0;
        transition: background 0.2s ease;
    }

    .filename {
        color: #2d3748;
        font-weight: 500;
        cursor: pointer;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .filename:hover {
        color: #4299e1;
        text-decoration: underline;
    }

    .file-meta {
        display: flex;
        gap: 15px;
        color: #718096;
    }

    .file-size::after {
        content: " • ";
        margin-left: 10px;
        color: #cbd5e0;
    }

    @media (max-width: 768px) {
        .file-item {
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .file-meta {
            justify-content: space-between;
        }
    }

    .custom-upload-btn {
        background: #ff416c;
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .custom-upload-btn:hover {
        background: #ff4b2b;
    }

    /* 状态框样式 */
    .status-box {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #e0e0e0;}

</style>
<script>
    // 获取DOM元素
    const fileInput = document.getElementById('fileInput');
    const statusText = document.getElementById('statusText');

    // 监听文件选择事件
    fileInput.addEventListener('change',  (e) => {
        const file = e.target.files[0];
        if (file) {
            statusText.textContent  = `已选择文件：${file.name}`;
        } else {
            statusText.textContent  = '未选择文件';
        }
    })
    // 智能环境适配（开发环境→生产环境自动切换）
    const API_BASE = (() => {
        const isLocal = window.location.hostname  === 'localhost' ||
            window.location.hostname  === '127.0.0.1';
        return isLocal ? 'http://localhost:8082' : window.location.origin;
    })();

    // 安全字符转义（防御XSS攻击）
    function escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent  = str;
        return div.innerHTML;
    }

    async function refreshFileList() {
        const fileListContainer = document.getElementById("fileList");
        try {
            // 显示加载状态
            fileListContainer.innerHTML  = '<div class="loading">加载文件列表中...</div>';

            // 发送请求并处理超时（5秒限制）
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(),  5000);

            const res = await fetch(`${API_BASE}/list`, {
                signal: controller.signal,
                headers: { 'Accept': 'application/json' }
            });
            clearTimeout(timeoutId);

            // 处理 HTTP 错误状态
            if (!res.ok)  throw new Error(`[${res.status}]  ${res.statusText}`);

            // 解析 JSON 并渲染列表
            const { files } = await res.json();
            if (files.length  === 0) {
                fileListContainer.innerHTML  = '<div class="empty">暂无上传文件</div>';
                return;
            }

            // 动态生成列表项（含安全转义）
            const listItems = files.map(filename  => `
            <ul class="file-table">
    <li class="file-item">
        <span class="filename"
              onclick="downloadFile('${encodeURIComponent(escapeHTML(filename))}')"
              title="点击下载文件">
            ${escapeHTML(filename)}
        </span>
    </li>
</ul>
        `).join('');

            fileListContainer.innerHTML  = `<ul>${listItems}</ul>`;
        } catch (error) {
            // 分类错误提示
            const errorMsg = error.name  === 'AbortError' ?
                '请求超时，请检查网络连接' :
                `加载失败: ${error.message}`;
            fileListContainer.innerHTML  = `<div class="error">${errorMsg}</div>`;
        }
    }

    // 文件上传（支持进度显示）
    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.files.length)  return alert('请先选择文件');

        const file = fileInput.files[0];
        const formData = new FormData();
        // 显式指定文件名参数
        formData.append('file',  file, encodeURIComponent(file.name));

        try {
            const res = await fetch(`${API_BASE}/upload`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    // 新增文件名请求头
                    'X-File-Name': encodeURIComponent(file.name)
                }
            });
            if (!res.ok)  throw new Error(await res.text());
            alert('上传成功');
            refreshFileList();
        } catch (error) {
            alert(`上传失败: ${error.message}`);
        }
    }

    // 文件下载（支持中文文件名）
    function downloadFile(filename) {
        const link = document.createElement('a');
        link.href  = `${API_BASE}/download?file=${filename}`;
        link.download  = decodeURIComponent(filename);
        link.click();
    }

    // 网页列表刷新策略，初始化刷新+每隔5秒刷新
    let refreshInterval;
    // 初始化定时刷新
    function initAutoRefresh() {
        // 立即加载第一次
        refreshFileList();

        // 启动5秒定时器
        refreshInterval = setInterval(() => {
            refreshFileList();
        }, 5000);

        // 页面隐藏时暂停刷新
        document.addEventListener('visibilitychange',  () => {
            if (document.hidden)  {
                clearInterval(refreshInterval);
            } else {
                refreshInterval = setInterval(refreshFileList, 5000);
            }
        });
    }
    // DOM加载后初始化
    document.addEventListener('DOMContentLoaded',  initAutoRefresh);

</script>
</body>
</html>